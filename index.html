<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ­ç¶²å€ç®¡ç†å¾Œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ”— çŸ­ç¶²å€ç®¡ç†ç³»çµ±</h2>
            <div id="g_id_onload"
                 data-client_id="726012910992-60ufmiqucaptr21sbgt06imohr39u9tb.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>

        <div id="admin-section" style="display: none;">
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">æ–°å¢ / ä¿®æ”¹é€£çµ</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="slug" class="form-control" placeholder="çŸ­ä»£ç¢¼ (ä¾‹å¦‚: sale)">
                        </div>
                        <div class="col-md-6">
                            <input type="url" id="original_url" class="form-control" placeholder="åŸå§‹ç¶²å€ (https://...)">
                        </div>
                        <div class="col-md-2">
                            <button onclick="upsertLink()" class="btn btn-primary w-100">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>çŸ­ä»£ç¢¼</th>
                                <th>ç›®æ¨™ç¶²å€</th>
                                <th>å»ºç«‹è€…</th>
                                <th>å‹•ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="link-list">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let USER_TOKEN = "";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx-DspFQPKKLxC8WUrGO6yHFdG-HOZURibjZabX_QfEAAN6vVbaVWA120y3GIgMdbDXdw/exec";

        // 1. è™•ç† Google ç™»å…¥å›å‚³
        function handleCredentialResponse(response) {
            USER_TOKEN = response.credential;
            document.getElementById('admin-section').style.display = 'block';
            fetchList();
        }

        // 2. æŠ“å–æ¸…å–®
        function fetchList() {
            fetch(`${GAS_URL}?action=list&id_token=${USER_TOKEN}`)
                .then(res => res.json())
                .then(res => {
                    if (res.status === "success") {
                        renderList(res.data);
                    } else {
                        alert("è®€å–å¤±æ•—: " + res.message);
                    }
                });
        }

        function renderList(data) {
            const tbody = document.getElementById('link-list');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td><code>/${item.slug}</code></td>
                    <td class="text-truncate" style="max-width: 300px;">${item.url}</td>
                    <td>${item.owner}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editLink('${item.slug}', '${item.url}')">ç·¨è¼¯</button>
                    </td>
                </tr>
            `).join('');
        }

        // 3. æ–°å¢æˆ–ä¿®æ”¹
        function upsertLink() {
            const slug = document.getElementById('slug').value;
            const original_url = document.getElementById('original_url').value;
            
            if(!slug || !original_url) return alert("è«‹å¡«å¯«å®Œæ•´");

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", // æ³¨æ„ï¼šGAS POST è·¨åŸŸå¸¸éœ€ä½¿ç”¨ no-cors
                body: JSON.stringify({
                    id_token: USER_TOKEN,
                    action: "upsert",
                    slug: slug,
                    original_url: original_url
                })
            }).then(() => {
                alert("è«‹æ±‚å·²é€å‡ºï¼(ç”±æ–¼è·¨åŸŸé™åˆ¶ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†æ¸…å–®)");
                fetchList();
            });
        }

        function editLink(slug, url) {
            document.getElementById('slug').value = slug;
            document.getElementById('original_url').value = url;
        }
    </script>
</body>
</html>